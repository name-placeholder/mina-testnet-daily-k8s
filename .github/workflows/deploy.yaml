name: Mina Testnet Deployment
run-name: Deploys a test network using latest Mina docker image
on:
  push:
  schedule:
    # daily at 5:00 UTC
    - cron: '0 5 * * *'
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get Latest Mina Tag
        id: get-tag
        run: |
          URL="https://hub.docker.com/v2/namespaces/minaprotocol/repositories/mina-daemon/tags?page_size=25"
          #URL=https://gist.githubusercontent.com/akoptelov/56c1ff38a0d0b1a82eec1a74f2fed856/raw/4a17548743f49827bd43215056493f8e870b90ba/tags.json
          JQ='.results | sort_by(.last_updated) | .[] | select(.name | endswith("focal-mainnet")) | .name'
          echo "tag=$(curl "$URL" | jq -cr "$JQ" | head -n 1)" >> $GITHUB_OUTPUT
      - run: echo "Using minaprotocol/mina-daemon:${{ steps.get-tag.outputs.tag }}"

      - name: Checkout Mina
        uses: actions/checkout@v3
        with:
          repository: name-placeholder/mina
          ref: helm-opemnima-additions
          path: mina

      - name: Configure Helm
        env:
          KUBECONFIG_CONTENT: ${{secrets.KUBECONFIG}}
        run: |
          umask 0077
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config

      - name: Deploy Testnet
        env:
          HELM_ARGS: |
            --install
            --values=values.yaml
            --set-file=mina.runtimeConfig=resources/daemon.json
            --set=mina.image=minaprotocol/mina-daemon:${{ steps.get-tag.outputs.tag }}
        run: |
          helm upgrade seeds mina/helm/seed-node $HELM_ARGS
          helm upgrade producers mina/helm/block-producer $HELM_ARGS
          helm upgrade snark-worker mina/helm/snark-worker/ $HELM_ARGS --set-file=publicKey=resources/key-05.pub
          for N in $(seq -w ${NODES_NUM:-3}); do
            helm upgrade node$N mina/helm/plain-node/ $HELM_ARGS --set=name=node$N
          done
          helm upgrade frondend mina/helm/openmina-frontend $HELM_ARGS
